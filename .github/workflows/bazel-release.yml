name: Bazel Build & Release

on:
  push:
    branches:
      - '**'

jobs:
  build-and-release:
    name: Build (amd64 & arm64) and publish release
    runs-on: ubuntu-latest
    permissions:
      contents: write  # needed to create releases and upload artifacts

    env:
      BAZEL_BUILD_TARGET: //:weft

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java (required by Bazel)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install Bazelisk
        run: |
          sudo curl -L -o /usr/local/bin/bazelisk https://github.com/bazelbuild/bazelisk/releases/download/v1.13.0/bazelisk-linux-amd64
          sudo chmod +x /usr/local/bin/bazelisk
          bazelisk --version

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'  # match your project's Go version

      - name: Configure output directory
        run: |
          mkdir -p release-artifacts

      - name: Mount bazel cache
        uses: actions/cache@v3
        with:
          path: "/home/runner/.cache/bazel"
          key: bazel

      - name: Build amd64 binary
        env:
          GOARCH: amd64
          GOOS: linux
        run: |
          # Use bazelisk to ensure consistent Bazel version; build the Go binary and copy the result.
          bazelisk build --platforms=@rules_go//go/toolchain:linux_amd64 "$BAZEL_BUILD_TARGET"
          mkdir -p release-artifacts
          # Bazel outputs are under bazel-bin; find the binary (go_binary produces an executable)
          cp "bazel-bin/weft" release-artifacts/weft-linux-amd64
          # If named differently, attempt to copy any matching binary
          if [ ! -f release-artifacts/weft-linux-amd64 ]; then
            find "$(bazelisk info bazel-bin)" -type f -name weft -exec cp {} release-artifacts/weft-linux-amd64 \;
          fi
          ls -l release-artifacts

      - name: Build arm64 binary
        env:
          GOARCH: arm64
          GOOS: linux
        run: |
          bazelisk build --platforms=@rules_go//go/toolchain:linux_arm64 "$BAZEL_BUILD_TARGET"
          cp "bazel-bin/weft" release-artifacts/weft-linux-arm64
          if [ ! -f release-artifacts/weft-linux-arm64 ]; then
            find "$(bazelisk info bazel-bin)" -type f -name weft -exec cp {} release-artifacts/weft-linux-arm64 \;
          fi
          ls -l release-artifacts 

      - name: Make artifacts executable
        run: |
          chmod +x release-artifacts/*
          file release-artifacts/*

      - name: Create release & upload artifacts
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          # Tag the release using commit SHA so it's created for every commit
          tag_name: ${{ github.sha }}
          name: Release ${{ github.sha }}
          body: Release for commit ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload binaries to release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.create_release.outputs.tag_name }}
          files: release-artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}