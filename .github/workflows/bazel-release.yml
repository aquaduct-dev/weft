name: Bazel Build & Release

on:
  push:
    branches:
      - 'main'

jobs:
  build-and-release:
    name: Build (amd64 & arm64) and publish release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write
      attestations: write
    env:
      BAZEL_BUILD_TARGET_AMD64: //:weft
      BAZEL_BUILD_TARGET_ARM64: //:weft_arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Login to `ghcr.io`
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Java (required by Bazel)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install Bazelisk
        run: |
          sudo curl -L -o /usr/local/bin/bazelisk https://github.com/bazelbuild/bazelisk/releases/download/v1.13.0/bazelisk-linux-amd64
          sudo chmod +x /usr/local/bin/bazelisk
          bazelisk --version

      - name: Configure output directory
        run: |
          mkdir -p release-artifacts

      - name: Restore Bazel cache
        uses: actions/cache/restore@v4
        with:
          path: "/home/runner/.cache/bazel"
          key: bazel-main

      - name: Test all
        run: |
          bazelisk test //...
      
      - name: Create tag
        run: |
            git config --local user.email "action@aquaduct.dev"
            git config --local user.name "Aquaduct System Action Daemon"
            git tag -a "v${{ github.run_number }}" -m "Release v${{ github.run_number }}"
            git push origin "v${{ github.run_number }}" || true
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build binaries
        env:
          GOARCH: amd64
          GOOS: linux
        run: |
          # Use bazelisk to ensure consistent Bazel version; build the Go binary and copy the result.
          bazelisk build --platforms=@rules_go//go/toolchain:linux_amd64 "$BAZEL_BUILD_TARGET_AMD64" "$BAZEL_BUILD_TARGET_ARM64"
          bazelisk build --platforms=@rules_go//go/toolchain:linux_amd64 "$BAZEL_BUILD_TARGET_AMD64"
          cp "bazel-bin/weft" release-artifacts/weft-linux-amd64
          bazelisk build --platforms=@rules_go//go/toolchain:linux_amd64 "$BAZEL_BUILD_TARGET_ARM64"
          cp "bazel-bin/weft_arm64" release-artifacts/weft-linux-arm64
          mkdir -p release-artifacts
          # Bazel outputs are under bazel-bin; find the binary (go_binary produces an executable)
          file release-artifacts/*
      - name: Deploy multiarch container
        run: |
          bazelisk run //container:weft_image_push -- --tag v${{ github.run_number }}
      - name: Save Bazel cache
        uses: actions/cache/save@v4
        with:
          path: "/home/runner/.cache/bazel"
          key: bazel-main

      - name: Make artifacts executable
        run: |
          chmod +x release-artifacts/*
          file release-artifacts/*

      - name: Create release & upload artifacts
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          # Tag the release using commit SHA so it's created for every commit
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          body: Release for commit ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload binaries to release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          files: release-artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}